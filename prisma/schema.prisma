// Prisma Schema for Creative Coloring Pages E-commerce

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Users table with authentication
model User {
  id            String    @id @default(uuid())
  name          String
  email         String    @unique
  password      String
  role          UserRole  @default(CUSTOMER)
  emailVerified Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  orders        Order[]
  downloads     Download[]
  cartItems     CartItem[]

  @@map("users")
}

enum UserRole {
  ADMIN
  CUSTOMER
}

// Categories (supports parent-child for subcategories)
model Category {
  id          String      @id @default(uuid())
  name        String
  slug        String      @unique
  description String?
  image       String?
  parentId    String?     @map("parent_id")
  parent      Category?   @relation("CategoryToCategory", fields: [parentId], references: [id])
  children    Category[]  @relation("CategoryToCategory")
  order       Int         @default(0)
  isActive    Boolean     @default(true) @map("is_active")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  
  products    Product[]

  @@map("categories")
}

// Products table
model Product {
  id            String      @id @default(uuid())
  title         String
  slug          String      @unique
  description   String?     @db.Text
  categoryId    String      @map("category_id")
  category      Category    @relation(fields: [categoryId], references: [id])
  price         Decimal     @default(0) @db.Decimal(10, 2)
  isFree        Boolean     @default(true) @map("is_free")
  isPremium     Boolean     @default(false) @map("is_premium")
  isFeatured    Boolean     @default(false) @map("is_featured")
  filePath      String?     @map("file_path")
  webpPath      String?     @map("webp_path")
  pdfPath       String?     @map("pdf_path")
  thumbnailPath String?     @map("thumbnail_path")
  tags          String[]    @default([])
  attributes    Json?       @db.JsonB
  customFields  Json?       @map("custom_fields") @db.JsonB
  gallery       String[]    @default([])  // Photo gallery URLs
  // Book parameters for Bookshop
  printLength   String?     @map("print_length")  // e.g. "150 pages"
  language      String?     // e.g. "English"
  dimensions    String?     // e.g. "8.5 x 11 inches"
  downloads     Int         @default(0)
  views         Int         @default(0)
  isActive      Boolean     @default(true) @map("is_active")
  createdAt     DateTime    @default(now()) @map("created_at")
  updatedAt     DateTime    @updatedAt @map("updated_at")
  
  bundleItems   BundleItem[]
  orderItems    OrderItem[]
  downloadLogs  Download[]
  cartItems     CartItem[]
  reviews       Review[]

  @@index([categoryId])
  @@index([slug])
  @@index([isFeatured])
  @@map("products")
}

// Bundles for grouping products
model Bundle {
  id          String      @id @default(uuid())
  title       String
  slug        String      @unique
  description String?     @db.Text
  price       Decimal     @db.Decimal(10, 2)
  image       String?
  tags        String[]    @default([])
  attributes  Json?       @db.JsonB
  customFields Json?      @map("custom_fields") @db.JsonB
  isActive    Boolean     @default(true) @map("is_active")
  isFeatured  Boolean     @default(false) @map("is_featured")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")
  
  items       BundleItem[]
  orderItems  OrderItem[]

  @@map("bundles")
}

// Bundle items (many-to-many between bundles and products)
model BundleItem {
  id        String   @id @default(uuid())
  bundleId  String   @map("bundle_id")
  bundle    Bundle   @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  productId String   @map("product_id")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  order     Int      @default(0)
  createdAt DateTime @default(now()) @map("created_at")

  @@unique([bundleId, productId])
  @@index([bundleId])
  @@index([productId])
  @@map("bundle_items")
}

// Orders
model Order {
  id              String      @id @default(uuid())
  orderNumber     String      @unique @map("order_number")
  userId          String      @map("user_id")
  user            User        @relation(fields: [userId], references: [id])
  amount          Decimal     @db.Decimal(10, 2)
  tax             Decimal     @default(0) @db.Decimal(10, 2)
  total           Decimal     @db.Decimal(10, 2)
  status          OrderStatus @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING) @map("payment_status")
  paymentMethod   String?     @map("payment_method")
  stripePaymentId String?     @map("stripe_payment_id")
  stripeSessionId String?     @map("stripe_session_id")
  email           String
  customerName    String      @map("customer_name")
  billingAddress  Json?       @map("billing_address") @db.JsonB
  metadata        Json?       @db.JsonB
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")
  
  items           OrderItem[]

  @@index([userId])
  @@index([orderNumber])
  @@index([status])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  PROCESSING
  COMPLETED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// Order items
model OrderItem {
  id          String   @id @default(uuid())
  orderId     String   @map("order_id")
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String?  @map("product_id")
  product     Product? @relation(fields: [productId], references: [id])
  bundleId    String?  @map("bundle_id")
  bundle      Bundle?  @relation(fields: [bundleId], references: [id])
  itemType    ItemType @map("item_type")
  title       String
  price       Decimal  @db.Decimal(10, 2)
  quantity    Int      @default(1)
  createdAt   DateTime @default(now()) @map("created_at")

  @@index([orderId])
  @@index([productId])
  @@index([bundleId])
  @@map("order_items")
}

enum ItemType {
  PRODUCT
  BUNDLE
}

// Download tracking
model Download {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id])
  productId String   @map("product_id")
  product   Product  @relation(fields: [productId], references: [id])
  ipAddress String?  @map("ip_address")
  userAgent String?  @map("user_agent")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([productId])
  @@map("downloads")
}

// Shopping cart
model CartItem {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String   @map("product_id")
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  quantity  Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, productId])
  @@index([userId])
  @@map("cart_items")
}

// Product Reviews
model Review {
  id          String   @id @default(uuid())
  productId   String   @map("product_id")
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  rating      Int      // 1-5 stars
  title       String?
  comment     String?  @db.Text
  authorName  String   @map("author_name")
  authorEmail String?  @map("author_email")
  isVerified  Boolean  @default(false) @map("is_verified")
  isApproved  Boolean  @default(true) @map("is_approved")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@index([productId])
  @@map("reviews")
}
